<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<META http-equiv="Content-Type" content="text/html; charset=windows-1251">
		<link rel="stylesheet" type="text/css" href="style/style.css">
		<title> Автоматический подбор сигнатур </title>
	</head>

	<body>
	<table cellpadding="25" align="center" >
			<tr>
				<td>
					<h2><span class="header">Автоматический подбор сигнатур</span></h2>
					<br>
					<p class="text">Доброе здрасте!</p> 
					<p class="text">Речь в статье пойдёт о необычных <span class="warning">антивирусных сигнатурах для PE-файлов</span>.</p>
					<p class="text">Например, такие продукты как <span class="warning">Avira, Emsisoft, Avast</span> могут назвать файл вредоносным, даже если в коде нет ничего, кроме MessageBoxA и ExitProcess. На лицо ложное срабатывание!</p>
					<p class="text">Логично предположить, что такой вердикт не зависит от эмулятора программного кода. Ответ кроется в структуре файла, таким образом, ложный детект выдаётся без глубокой проверки. Есть множество способов обойти эмулятор и скрыть попавшие в сигнатуру байты. Но данная ситуация более фундаментальна, детект выдаётся без анализа содержимого.</p>
					<p class="text">Я говорю именно про такую ситуацию, когда содержимое pe-файла сомнений не вызывает: легальный импорт, код, данные etc. У каждого антивируса своя система проверок, импорт может входить в ту сигнатуру, о которой пойдёт речь. Из всего этого мы делаем вывод, что в описываемой ситуации бесполезно искать сигнатуру, затирая отдельные части исходного файла.</p>
					<p class="text">Итак, под структурой файла я буду иметь в виду:</p>
					
					<ul>
					<li>структуру секций: имена, размер\соотношение размеров, порядок;</li>
					<li>энтропию секций.</li>
					</ul>
					
					<p class="text">Сигнатуры - вещь крайне текучая, если не сказать однодневная. Дабы не быть голословным, я покажу несколько файлов.</p>

					<p class="text">Тот самый файл, отображающий сообщение, рассмотрим на примерах.</p>

<PRE>
1) имена
 - 3 секции: .text .rdata .data.
 - При проверке - (Avira)TRCrypt.XPACK.Gen.
 - Изменим имя секции .rdata (например, на .sdata)  - (Avira) OK.
 
2) порядок 
 - 3 секции .data .sdata .text.
 - При проверке - (Avira)TRCrypt.XPACK.Gen. 
 - Переставим секции местами: .text .data .sdata - (Avira) OK.
 - Последняя исполняемая секция может намекать на заражение файла.

3) размеры
 - 3 секции .text (Raw Size = 00000600) .sdata (Raw Size = 00000200) .data (Raw Size = 00006600).	
 - При проверке - (Avira)TRDropper.Gen.
 - 3 секции: .text (Raw Size = 00003400) .sdata (Raw Size = 00000200) .data (Raw Size = 00006600) - (Avira) OK.
 - Нормальное соотношение размеров убирает детект.
 
4) энтропия
 - 3 секции .text (entropy = 3.79) .sdata (entropy = 1.12) .data (entropy = 7.79).
 - При проверке - (emsisoft) Gen.Trojan.Heur.FU.
 - разбавим энтропию последней секции.
 - .text (entropy = 3.79) .sdata (entropy = 1.12) .data (entropy = 3.77) - (emsisoft) OK.
</PRE>

					<p class="text">Все эти характеристики могут сложиться в сигнатуру, описывающую наш файл. Разумеется, обычный компилятор выдаёт статичную структуру секций, но если файл собирает криптор - об этом не может быть и речи. Для меня подобные сигнатуры стали последней преградой перед сокрытием файлов от антивирусов.</p>

					<p class="text">Я пробовал разные варианты, искал универсальное решение. В итоге я пришёл к тому, что <span class="warning">удобнее всего искать подходящую структуру файла аналитически</span>. Подбор всех возможных вариантов (размер\энтропия) на заданном интервале, с последующей проверкой антивирусом, дал огромный отчёт из повторяющихся значений. Анализировать его вручную затруднительно, общие закономерности искались на графиках. Именно тогда я понял, на сколько важен размер секции. <span class="warning">К сожалению, полный перебор файлов для поиска сигнатур бесперспективен</span>. Но можно понять общие принципы, и находить подходящую структуру станет проще.</p>


					<p class="text">Для иллюстрации идеи я написал <span class="warning">fasm-based генератор</span>. Сам по себе он ничего полезного не делает. Но в руках аналитика может стать инструментом для быстрой чистки. Всё просто: мы задаём значение энтропии, и генератор создаёт блок данных с приблизительно такой же энтропией. Данные вставляются в файл, выравнивая (через повторения) секцию до нужного размера. В итоге, получаем файл с заданными размером секций и энтропией. Код файла и структуру секций можно менять, для этого и используется компилятор fasm.</p>
					
					
					
					<p class="text">Генератор принимает 4 параметра через командную строку, первые два параметра - размеры секций в хексе, и вторые два - их энтропия. В названии выходного файла будет фактический размер двух секций и их энтропия. Запусти "gen.exe 1000 1000 1 1" - создаёт файл с заданным размером секций и энтропией. На маленьких файлах будут отклонения из-за размера\энтропия данных стаба, также, принимай во внимание выравнивание секций. Подробности смотри в masm исходнике. Ок, я прикладываю этот файл чисто как пример, буду рад, если ты решишь развить эту тему в нечто более серьёзное.</p>

					<p class="text">Поиграем с параметрами: </p> 
					
<PRE>
	>1000 1000 0 8
	code(00001200 0.4879)data(00001200 7.6350)
	(BitDefender) Trojan.CryptRedol.Gen.5
	..
	code(00001200 0.4879)data(00001200 6.5290)
	(BitDefender) Trojan.CryptRedol.Gen.5
	..
	code(00001200 0.4879)data(00001200 5.6044)
	(BitDefender)  OK
</PRE>
					
					<p class="text">Сделав несколько генераций, "пошатав" параметры генератора и\или структуру секций в разные стороны - находим "чистую" структуру файла.</p>
					
<PRE>
	>29000 C00 6 6
	code(00029200 5.9925)data(00000E00 5.4932)
	(BitDefender) Gen:Variant.Zusy.66894
	
	code(00029200 3.9720)data(00000E00 3.6716)
	(BitDefender) Gen:Variant.Symmi.657

	уберем секцию ресурсов из stub.asm
	code(00029200 3.9721)data(00000E00 3.6740)
	(BitDefender) ok
</PRE>

					<p class="text">такие дела.</p><br>
					
					<p class="warning">Исходники: <a href="sources/valentin_p/autosign" target="_blank">sources/valentin_p/autosign</a></p>


<p class="warning"><br>______________________________<br>
valentin_p<br> 
http://coru.ws<br>
2013<br><br>
Inception E-Zine</p>

				</td>
			</tr>
		</table>
	</body>
</html>